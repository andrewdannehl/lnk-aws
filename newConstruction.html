<!DOCTYPE html>
<html>
<head>
  <title>New Construction</title>
  <link rel="stylesheet" href="styles/style.css" />
  <script defer>
    document.addEventListener('DOMContentLoaded', function () {
      const submitBtn = document.querySelector('#submit');
      const form = document.querySelector('#newConstructionForm');

      submitBtn.addEventListener('click', function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const jsonData = Object.fromEntries(formData.entries());

        fetch('https://q2g27tp299.execute-api.us-east-2.amazonaws.com/deploy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(jsonData)
        })
        .then(async res => {
          const rawText = await res.text();
          let data;
          try {
            data = JSON.parse(rawText);
          } catch (err) {
            document.getElementById('resultsContainer').innerHTML = `<div style="color: red;">Failed to parse server response.</div>`;
            return;
          }
          if (!res.ok) {
            document.getElementById('resultsContainer').innerHTML = `<div style="color: red;">${data.error || 'Server returned an error.'}</div>`;
            return;
          }
          // Render results table
          const tableHTML = `
            <table id="resultsTable" style="width:100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #ddd;">
                  <th onclick="sortTable(0)">Address <span class="sort-icon" data-col="0"></span></th>
                  <th onclick="sortTable(1)">Price ($) <span class="sort-icon" data-col="1"></span></th>
                  <th onclick="sortTable(2)">SqFt <span class="sort-icon" data-col="2"></span></th>
                  <th onclick="sortTable(3)">Sale Date <span class="sort-icon" data-col="3"></span></th>
                  <th onclick="sortTable(4)">$/SF <span class="sort-icon" data-col="4"></span></th>
                </tr>
              </thead>
              <tbody>
                ${data.properties.map(p => `
                  <tr>
                    <td>${p.address}</td>
                    <td>$${Number(p.price).toLocaleString()}</td>
                    <td>${Number(p.sqFt).toLocaleString()}</td>
                    <td>${new Date(p.formatSaleDate).toISOString().slice(0, 10)}</td>
                    <td>$${Number(p.pricePerSF).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          document.getElementById('resultsContainer').innerHTML = tableHTML;
        })
        .catch(err => {
          document.getElementById('resultsContainer').innerHTML = `<div style="color: red;">${err.message}</div>`;
        });
      });
    });

    // Sorting function (same as your script)
    let sortDirection = {};
    function sortTable(colIndex) {
      const table = document.getElementById('resultsTable');
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const isNumeric = colIndex !== 0 && colIndex !== 3;
      const direction = sortDirection[colIndex] === 'asc' ? 'desc' : 'asc';
      sortDirection[colIndex] = direction;
      rows.sort((a, b) => {
        const aText = a.children[colIndex].textContent.trim().replace(/[$,]/g, '');
        const bText = b.children[colIndex].textContent.trim().replace(/[$,]/g, '');
        const aVal = isNumeric ? parseFloat(aText) : aText.toLowerCase();
        const bVal = isNumeric ? parseFloat(bText) : bText.toLowerCase();
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
      document.querySelectorAll('.sort-icon').forEach(span => { span.textContent = ''; });
      const iconSpan = document.querySelector(`.sort-icon[data-col=\"${colIndex}\"]`);
      if (iconSpan) { iconSpan.textContent = direction === 'asc' ? '▲' : '▼'; }
    }
  </script>
</head>
<body>
  <h1>New Construction Submission</h1>
  <!-- ...form as in your original HTML... -->
  <form id="newConstructionForm">
    <!-- form fields here -->
    <button type="submit" id="submit">Submit All</button>
  </form>
  <div id="resultsContainer"></div>
</body>
</html>