<!DOCTYPE html>
<html>
<head>
  <title>New Construction</title>
  <link rel="stylesheet" href="styles/style.css" />
  <script defer>
    document.addEventListener('DOMContentLoaded', function () {
      const submitBtn = document.querySelector('#submit');
      const form = document.querySelector('#newConstructionForm');

      submitBtn.addEventListener('click', function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const jsonData = Object.fromEntries(formData.entries());

        fetch('https://q2g27tp299.execute-api.us-east-2.amazonaws.com/query/newConstruction', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(jsonData)
        })
        .then(async res => {
          const rawText = await res.text();
          let data;
          try {
            data = JSON.parse(rawText);
          } catch (err) {
            document.getElementById('resultsContainer').innerHTML = `<div style="color: red;">Failed to parse server response.</div>`;
            return;
          }
          if (!res.ok) {
            document.getElementById('resultsContainer').innerHTML = `<div style="color: red;">${data.error || 'Server returned an error.'}</div>`;
            return;
          }
          // Render results table
          const tableHTML = `
            <table id="resultsTable" style="width:100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #ddd;">
                  <th onclick="sortTable(0)">Address <span class="sort-icon" data-col="0"></span></th>
                  <th onclick="sortTable(1)">Price ($) <span class="sort-icon" data-col="1"></span></th>
                  <th onclick="sortTable(2)">SqFt <span class="sort-icon" data-col="2"></span></th>
                  <th onclick="sortTable(3)">Sale Date <span class="sort-icon" data-col="3"></span></th>
                  <th onclick="sortTable(4)">$/SF <span class="sort-icon" data-col="4"></span></th>
                </tr>
              </thead>
              <tbody>
                ${data.properties.map(p => `
                  <tr>
                    <td>${p.address}</td>
                    <td>$${Number(p.price).toLocaleString()}</td>
                    <td>${Number(p.sqFt).toLocaleString()}</td>
                    <td>${new Date(p.formatSaleDate).toISOString().slice(0, 10)}</td>
                    <td>$${Number(p.pricePerSF).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          document.getElementById('resultsContainer').innerHTML = tableHTML;
        })
        .catch(err => {
          document.getElementById('resultsContainer').innerHTML = `<div style="color: red;">${err.message}</div>`;
        });
      });
    });

    // Sorting function (same as your script)
    let sortDirection = {};
    function sortTable(colIndex) {
      const table = document.getElementById('resultsTable');
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const isNumeric = colIndex !== 0 && colIndex !== 3;
      const direction = sortDirection[colIndex] === 'asc' ? 'desc' : 'asc';
      sortDirection[colIndex] = direction;
      rows.sort((a, b) => {
        const aText = a.children[colIndex].textContent.trim().replace(/[$,]/g, '');
        const bText = b.children[colIndex].textContent.trim().replace(/[$,]/g, '');
        const aVal = isNumeric ? parseFloat(aText) : aText.toLowerCase();
        const bVal = isNumeric ? parseFloat(bText) : bText.toLowerCase();
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
      document.querySelectorAll('.sort-icon').forEach(span => { span.textContent = ''; });
      const iconSpan = document.querySelector(`.sort-icon[data-col=\"${colIndex}\"]`);
      if (iconSpan) { iconSpan.textContent = direction === 'asc' ? '▲' : '▼'; }
    }
  </script>
</head>
<body>
  <h1>New Construction Submission</h1>

  <form id="newConstructionForm">
  <!-- Property Details -->
  <label for="address">Street Address</label>
  <input type="text" id="address" name="address" required>

  <label for="zip">Zip Code</label>
  <input type="text" id="zip" name="zip" required>

  <label for="price">Price ($)</label>
  <input type="text" id="price" name="price" required>

  <label for="sqFt">Square Feet</label>
  <input type="text" id="sqFt" name="sqFt" required>

  <label for="lot">Lot Size (SF)</label>
  <input type="number" id="lot" name="lot" step="100" required>

  <hr>
  <h2>Filters</h2>

  <!-- Filter Sliders & Inputs -->
  <div class="slider-group">
    <!-- Distance Slider -->
    <div class="slider-label">
      <label for="distance">Distance (miles)</label>
      <span class="value-display" id="distanceVal">0</span>
    </div>
    <input type="range" id="distance" name="distance" min="0" max="10" step="0.1" value="1" oninput="distanceVal.innerText = this.value">
    <!-- Square Feet Min/Max -->
    <div class="slider-label">
      <label>Square Feet +/-</label>
      <input type="number" name="minSqFt" placeholder="Min" min="-500" max="0" step="10" value="-250">
      <input type="number" name="maxSqFt" placeholder="Max" min="0" max="500" step="10" value="250">
    </div>

    <!-- $/SF Min/Max -->
    <div class="slider-label">
      <label>$/SF +/-</label>
      <input type="number" name="minPricePerSF" placeholder="Min" min="-50" max="0" step="1" value="-20">
      <input type="number" name="maxPricePerSF" placeholder="Max" min="0" max="50" step="1" value="20">
    </div>

    <!-- Lot Size Min/Max -->
    <div class="slider-label">
      <label>Lot Size (sqft) +/-</label>
      <input type="number" name="minLotSize" placeholder="Min" min="-5000" max="0" step="100" value="-3000">
      <input type="number" name="maxLotSize" placeholder="Max" min="0" max="5000" step="100" value="3000">
    </div>

    <!-- Built Within Slider -->
    <div class="slider-label">
      <label for="builtWithin">Built Within (years)</label>
      <span class="value-display" id="builtWithinVal">3</span>
    </div>
    <input type="range" id="builtWithin" name="builtWithin" min="0" max="60" step="1" value="3" oninput="builtWithinVal.innerText = this.value">

    <!-- Sold Within Slider -->
    <div class="slider-label">
      <label for="soldWithin">Sold Within (months)</label>
      <span class="value-display" id="soldWithinVal">12</span>
    </div>
    <input type="range" id="soldWithin" name="soldWithin" min="0" max="120" step="1" value="12" oninput="soldWithinVal.innerText = this.value">

  </div>

  <button type="submit" id="submit">Submit All</button>
  </form>
  <div id="queryMessage"></div>
  <div id="resultsContainer"></div>
</body>
</html>